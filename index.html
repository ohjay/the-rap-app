<!DOCTYPE html>
<html lang="en">
<head>
	<link rel="icon" href="images/dragonhead.ico">
    <title>The Rap App</title>
    
    <link rel="stylesheet" href="css/style.css" />
    <link href=' http://fonts.googleapis.com/css?family=Roboto+Condensed' rel='stylesheet' type='text/css'>
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script>
        // Create a new instance of an audio object and adjust some of its properties
        var audio = new Audio();
        audio.src = 'rap_app_instrumentals/freestyle_rap.mp3';
        audio.controls = true;
        audio.loop = true;
        audio.autoplay = false;
        // Establish all variables that your Analyser will use
        var canvas, ctx, source, context, analyser, fbc_array, bars, bar_x, bar_width, bar_height;
        // Initialize the MP3 player after the page loads all of its HTML into the window
        window.addEventListener("load", initMp3Player, false);
        function initMp3Player(){
            //document.getElementById('audio_box').appendChild(audio);

            startbtn = document.getElementById("start");
            startbtn.addEventListener("click", start);

            function start() {
                if (audio.paused) {
                    audio.play();
                    startbtn.innerHTML = '<button type="button">Stop</button>';
                } else {
                    audio.pause();
                    startbtn.innerHTML = '<button type="button">Start</button>';
                }
        
            }

            // Kendrickbtn = document.getElementById("Kendrick");
            // Drakebtn = document.getElementById("Drake");
            // Colebtn = document.getElementById("Cole");
            // Kanyebtn = document.getElementById("Kanye");

            // Kendrickbtn.addEventListener("click", beat("Kendrick"));
            // Drakebtn.addEventListener("click", beat("Drake"));
            // Colebtn.addEventListener("click", beat("Cole"));
            // Kanyebtn.addEventListener("click", beat("Kanye"));

            function beat(name) {
                if (audio.src.indexOf('rap_app_instrumentals/freestyle_rap.mp3') == - 1) {
                    audio.src = 'rap_app_instrumentals/freestyle_rap.mp3';
                } else if (name === "Kendrick") {
                    audio.src = 'rap_app_instrumentals/money_trees.mp3';
                } else if (name === "Drake") {
                    audio.src = 'rap_app_instrumentals/back_to_back.mp3';
                } else if (name === "Cole") {
                    audio.src = 'rap_app_instrumentals/slow.mp3';
                } else if (name === "Kanye") {
                    audio.src = 'rap_app_instrumentals/medium.mp3';
                }
                
                if (audio.paused) {
                    audio.play();
                    startbtn.innerHTML = '<button type="button">Stop</button>'
                }
            }
            
            $('#Drake').click(function() { beat('Drake'); });
            $('#Cole').click(function() { beat('Cole'); });
            $('#Kanye').click(function() { beat('Kanye'); });
            $('#Kendrick').click(function() { beat('Kendrick'); });

            context = new webkitAudioContext(); // AudioContext object instance
            analyser = context.createAnalyser(); // AnalyserNode method
            canvas = document.getElementById('analyser_render');
            ctx = canvas.getContext('2d');
            // Re-route audio playback into the processing graph of the AudioContext
            source = context.createMediaElementSource(audio); 
            source.connect(analyser);
            analyser.connect(context.destination);
            frameLooper();
        }
        // frameLooper() animates any style of graphics you wish to the audio frequency
        // Looping at the default frame rate that the browser provides(approx. 60 FPS)
        function frameLooper(){
            window.webkitRequestAnimationFrame(frameLooper);
            fbc_array = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(fbc_array);
            ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear the canvas
            ctx.fillStyle = '#00CCFF'; // Color of the bars
            bars = 100;
            for (var i = 0; i < bars; i++) {
                bar_x = i * 3;
                bar_width = 2;
                bar_height = -(fbc_array[i] / 2);
                //  fillRect( x, y, width, height ) // Explanation of the parameters below
                ctx.fillRect(bar_x, canvas.height, bar_width, bar_height);
            }
        }
    </script>
</head>

<body style="background-color: #000000">
    <div id="mp3_player">
      <div id="audio_box"></div>
      <canvas id="analyser_render"></canvas>
    </div>
	<!--
	<p> </p>
	<p> </p>
	<p> Yeah, I learned the game from William Wesley you can never check me </p>
	<p> ___ </p>
	<p> Back to back for the n****s that didn't get the message </p>
	<p> ___ </p>
	<p> Back to back like I'm on the cover of Lethal Weapon </p>
	<p> ___ </p>
	<p> Back to back like I'm Jordan '96, '97 </p>
	-->

	<!-- Images -->
	<div id="Drake">
        <img src = "images/drake-black-background(newest).png" alt="Drake" height="280"/>
    </div>

    <div id="Cole">
        <img src = "images/j-cole-black-background(new).png" alt="Cole" height="340"/>
    </div>

    <div id="Kanye">
        <img src = "images/kanye-black-background.png" alt="Kanye" height="380"/>
    </div>

    <div id="Kendrick">
        <img src = "images/kendrick-black-background(new).png" alt="Kendrick" height="260"/>
    </div>

    <p>
        Hey, welcome to the Rap App! I'm just testing out some speech recognition stuff right now.
        <div id="log"></div>
        <div id="final-word"></div>
        <div id="rhymes"></div>
        <div style="text-align: center">
            <span id="typed"></span>
        </div>
    </p>

    <!-- Buttons -->
    <div id="start">
    	<button type="button">Start</button>
    </div>
    
    <!-- Scripts -->
    <script src="js/typed.min.js"></script>
    <script src="js/trie.js"></script>
    <script src="js/mobypron.js"></script>
    <script src="js/rhyme_lookup.js"></script>
    <script>
        var newSpeechRecognition = function() {
            $("#typed").typed({
                strings: ["Coconut strips and...", "^1000 banana chips."],
                typeSpeed: 0,
                backDelay: 500
            });
            
            var r = new webkitSpeechRecognition();
            // r.interimResults = true;
            // r.continuous = true;
        
            r.onresult = function(event) {
                /* Only the final word */
                if (event.results[event.results.length - 1].isFinal) {
                    var finalPhrase = event.results[event.results.length - 1][0].transcript;
                    var finalWord = finalPhrase.substring(finalPhrase.lastIndexOf(' ') + 1);
                    
                    document.getElementById("final-word").innerHTML = "You said: " + finalPhrase;
                    document.getElementById("rhymes").innerHTML = "Rhymes: " + lookup(finalWord).toString();
                    r.stop();
                }
            
                /* All words:
                var final_transcript = '';
                var interim_transcript = '';
            
                for (var i = event.resultIndex; i < event.results.length; i++) {
                    if (event.results[i].isFinal) {
                        final_transcript += event.results[i][0].transcript;
                        r.stop();
                    } else {
                        interim_transcript += event.results[i][0].transcript;
                    }
                }
        
                document.getElementById("final-transcript").innerHTML = final_transcript;
                document.getElementById("interim-transcript").innerHTML = interim_transcript; */
            };
        
            r.onerror = function(event) {
                $('#log').text('[ERROR]: ' + event.error);
            };
        
            r.onend = function() {
                recognition = newSpeechRecognition();
                recognition.start();
            };
        
            return r;
        };
    
        var recognition = newSpeechRecognition();
        recognition.start();
    </script>
</body>
</html>